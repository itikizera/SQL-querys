 USE [MP11_HOM]
GO

/****** Object:  StoredProcedure [dbo].[PARADA]    Script Date: 20/06/2014 16:35:18 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO








ALTER PROCEDURE [dbo].[PARADA]

AS
BEGIN


SELECT * FROM (
SELECT *,STATUS_INICIAL+STATUS_FINAL AS STATUSGERAL FROM (
SELECT 
  CASE  
	WHEN AB6_STATUS = 'A' THEN 'ABERTA' 
	WHEN AB6_STATUS = 'E' THEN 'FINALZADA' 
	WHEN AB6_STATUS = 'B' THEN 'ATENDIDA' 
  END AS AB6_LEGEND,
 ISNULL(AB7_CODPRO,'') AS ITEM,
 ISNULL(AB7_NUMSER,'REGISTRO NÃO INFORMADO')AB7_NUMSER, 
  CASE
	WHEN AB7_TIPO = '1' THEN 'OS'
    WHEN AB7_TIPO = '2' THEN 'Pedido Atendido'
    WHEN AB7_TIPO = '3' THEN 'Em Andamento'
    WHEN AB7_TIPO = '4' THEN 'Atendido'
    WHEN AB7_TIPO = '5' THEN 'Encerrado'
  ELSE 'TIPO NÃO INFORMADO' END AS AB7_TIPO,
  SUBSTRING(A1_NOME,1,35) AS A1_NOME, 
  ISNULL(ABE_DATA, '') ABE_DATA, 
  ISNULL (ABE_DTORIG,'') ABE_DTORIG, 
  ISNULL(AAH_CONTRT,'')AAH_CONTRT, 
  AB6_FILIAL, 
  ISNULL(AB6_NUMOS, '') AS NUMERO_OS, 
  ISNULL(AB6_XNUMOR,'') AS OS_ORIGEM,
  ISNULL(AB6_XSTSOP,'') AS STATUS_INICIAL,  --STATUS NA ABERTURA
  ISNULL((SELECT TOP 1 AB9_XSTSOP FROM AB9010 WHERE AB9_NUMOS=AB7_NUMOS+AB7_ITEM AND D_E_L_E_T_=''),'') AS STATUS_FINAL, -- STATUS NO ENCERRAMENTO
  --(SELECT CASE WHEN AB9_XSTSOP IS NULL THEN AB6_XSTSOP ELSE AB6_XSTSOP+AB9_XSTSOP END FROM AB9010 WHERE AB9_NUMOS=AB7_NUMOS+AB7_ITEM AND D_E_L_E_T_='') AS STATUS_GERAL,
  AB6_CODCLI, 
  AB6_LOJA, 
  AB6_EMISSA, 
  AB6_ATEND, 
  AB6_STATUS, 
  AB6_CONPAG, 
  AB6_HORA, 
  AB6_REGIAO, 
  AB6_MSG, 
  AB6_MOEDA, 
  AB6_TXMOED, 
  AB6_NUMLOJ, 
  AB6_CONTRT, 
  AB6_TPCONT, 
  A1_END,
  AB6.R_E_C_N_O_ AS AB6_RECNO
  FROM 
  AB6010 AB6 
  LEFT JOIN SA1010 SA1 ON A1_COD=AB6_CODCLI AND A1_LOJA=AB6_LOJA AND SA1.D_E_L_E_T_='' 
  LEFT JOIN AB7010 AB7 ON AB7_NUMOS=AB6_NUMOS AND AB7.D_E_L_E_T_='' 
  LEFT JOIN AB9010 AB9 ON AB9_NUMOS=AB6_NUMOS AND AB9.D_E_L_E_T_ = ''
  LEFT JOIN ABE010 ABE ON ABE_NUMOS=AB6_NUMOS AND ABE.D_E_L_E_T_='' 
  LEFT JOIN AAH010 AAH ON AAH_CODCLI=AB6_CODCLI AND AAH_LOJA = AB6_LOJA AND AAH.D_E_L_E_T_=''
) TRB
)TRB2
--WHERE
--AB6_CODCLI  BETWEEN '00020R' AND '00020R'
--STATUSGERAL IN ( 'FF','FP','PF','PP','FFPF','FPPP','')

END


GO


