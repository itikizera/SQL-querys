SELECT D2.D2_FILIAL,  BM.BM_DESC AS LINHAS, A1.A1_NREDUZ, B1.B1_DESC, D2.D2_COD, D2.D2_LOCAL AS ARMAZEM,
 MAX(D2.D2_QUANT) AS FOLHAS,  B2.B2_USAI AS ULTUTIL, DATEDIFF(DAY, CONVERT(DATETIME , B2.B2_USAI, 103), GETDATE()) AS DIASESTOQUE, 
 ISNULL(A3.A3_COD,'') AS A3_COD, ISNULL(A3.A3_NREDUZ,'') AS A3_NOME,              
 COUNT(D2.D2_ITEM) AS CORPOS, (MAX(D2.D2_QUANT)*COUNT(D2.D2_ITEM)) AS LATASMONTAR, A1.A1_COD,
 MAX(D2.D2_PRCVEN) AS CUSTOUNI, MAX(D2.D2_TOTAL) AS CUSTOMEDIO,                          
MAX(LEFT(D2.D2_EMISSAO,6)) AS MESREF             
FROM SD2990 D2																					 				
LEFT JOIN SF2990 F2 ON D2.D2_FILIAL = F2.F2_FILIAL AND F2.F2_DOC = D2.D2_DOC AND D2.D_E_L_E_T_='' 		
LEFT JOIN SB1990 B1 ON D2.D2_FILIAL = B1.B1_FILIAL AND D2.D2_COD = B1.B1_COD AND B1.D_E_L_E_T_='' 
LEFT JOIN SB2990 B2 ON D2.D2_FILIAL = B2.B2_FILIAL AND D2.D2_COD = B2.B2_COD AND B2.D_E_L_E_T_=''
LEFT JOIN SA1990 A1 ON D2.D2_CLIENTE = A1.A1_COD AND D2.D2_LOJA = A1.A1_LOJA AND A1.D_E_L_E_T_=''
LEFT JOIN SBM990 BM ON B1.B1_GRUPO = BM.BM_GRUPO AND BM.D_E_L_E_T_=''								
LEFT JOIN SA3990 A3 ON F2.F2_VEND1 = A3.A3_COD AND A3.D_E_L_E_T_=''  																																		 				
WHERE D2.D2_TIPO = 'N' AND B1.B1_UM = 'FL'  
AND D2.D2_FILIAL BETWEEN  '' AND 'ZZ'    		
AND D2.D2_EMISSAO BETWEEN  '20140101' AND '20141231'									
AND A1.A1_COD BETWEEN  '' AND 'ZZZZZZ'
AND A1.A1_LOJA BETWEEN  '' AND 'ZZ'
GROUP BY D2.D2_FILIAL, A3.A3_COD, A3.A3_NREDUZ, BM.BM_DESC, A1.A1_NREDUZ,A1.A1_COD, B1.B1_DESC, 
D2_COD, D2.D2_LOCAL,B2.B2_QATU,B2.B2_USAI,        
LEFT(D2_EMISSAO,6), B1.B1_DESC, D2_COD,LEFT(D2_EMISSAO,6)										